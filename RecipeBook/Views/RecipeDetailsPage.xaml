<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:RecipeBook.Converters"
             x:Class="RecipeBook.Views.RecipeDetailsPage"
             Title="Recipe Details">

    <ContentPage.Resources>
        <converters:Base64ToImageConverter x:Key="Base64ToImageConverter" />
        <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
        <converters:BoolToFavoriteTextConverter x:Key="BoolToFavoriteTextConverter" />
        <converters:BoolToFavoriteColorConverter x:Key="BoolToFavoriteColorConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">
            <!-- Recipe Image -->
            <Frame IsClippedToBounds="True" CornerRadius="10" Padding="0" HeightRequest="200" 
                   IsVisible="{Binding Recipe.ImageBase64, Converter={StaticResource StringToBoolConverter}}">
                <Image Aspect="AspectFill" 
                       Source="{Binding Recipe.ImageBase64, Converter={StaticResource Base64ToImageConverter}}" />
            </Frame>

            <!-- Recipe Title -->
            <Label Text="{Binding Recipe.Title}" 
                   FontSize="24" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Center" />

            <!-- Recipe Description -->
            <Frame BorderColor="LightGray" Padding="10" CornerRadius="5">
                <Label Text="{Binding Recipe.Description}" 
                       FontSize="16" />
            </Frame>

            <!-- Ingredients Section -->
            <Label Text="Ingredients" 
                   FontSize="20" 
                   FontAttributes="Bold" 
                   Margin="0,10,0,0" />

            <CollectionView ItemsSource="{Binding Recipe.Ingredients}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="5" ColumnDefinitions="*, Auto">
                            <Label Text="{Binding Name}" Grid.Column="0" />
                            <Label Text="{Binding Quantity}" Grid.Column="1" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Steps Section -->
            <Label Text="Steps" 
                   FontSize="20" 
                   FontAttributes="Bold" 
                   Margin="0,10,0,0" />

            <!-- Using a ListView instead of CollectionView for better index support -->
            <ListView ItemsSource="{Binding Recipe.Steps}" 
                      HasUnevenRows="True" 
                      SeparatorVisibility="None"
                      SelectionMode="None">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <ViewCell>
                            <Grid Padding="5" ColumnDefinitions="Auto, *">
                                <Label Text="{Binding Text}" 
                                       Grid.Column="1" 
                                       Margin="5,0,0,0" />
                            </Grid>
                        </ViewCell>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <!-- Action Buttons -->
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="10" Margin="0,20,0,0">
                <!-- Favorite Button (always visible) -->
                <Button Text="{Binding IsFavorite, Converter={StaticResource BoolToFavoriteTextConverter}}"
                        Command="{Binding ToggleFavoriteCommand}"
                        BackgroundColor="{Binding IsFavorite, Converter={StaticResource BoolToFavoriteColorConverter}}"
                        WidthRequest="120" />

                <!-- Edit Button (visible only for owner) -->
                <Button Text="Edit" 
                        Command="{Binding EditRecipeCommand}"
                        IsVisible="{Binding IsOwner}"
                        BackgroundColor="#5B8C5A"
                        WidthRequest="120" />

                <!-- Delete Button (visible only for owner) -->
                <Button Text="Delete" 
                        Command="{Binding DeleteRecipeCommand}"
                        IsVisible="{Binding IsOwner}"
                        BackgroundColor="#C75450"
                        WidthRequest="120" />
            </HorizontalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>